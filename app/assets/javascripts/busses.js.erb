// Declare variable for current schedule
var currentSchedule;
var stopValue = null;

// Log item to console
function debug(data) {
	console.log(data);
}

// Get schedule based on route and day selection in DOM and render template
function getSchedule() {

		// Weekday/weekend schedule
		var day = $(".days input:checked").attr("value");
		if (day != "") {
			day = "-" + day;
		}

		// Save href of clicked link
		var href = "/busses/" + $(".bus-route option:selected").attr("value") + day;

		// Ajax request for schedule JSON of clicked route
		$.ajax({
			url: href,
			type: 'GET',
			dataType: 'json'
		}).done(function(data) {
			
			// After getting response
			var template;

			// Template source on index view
			var source = $("#bus-stops-template").html();

			// If data was received (data is JSON object for bus route)
			if (data) {

				// Store schedule
				currentSchedule = data;

				// Store all stop names
				var fullStopNames = _.keys(currentSchedule);

				// Shorten stop names
				var shortStopNames = _.map(fullStopNames, function(stopName) {
					return stopName.slice(17);
				});

				// Create object to send to template
				var context = { stopNames: [] }
				for (var i = 0; i < fullStopNames.length; i++) {
					context.stopNames[i] = {
						shortName : shortStopNames[i],
						fullName : fullStopNames[i]
					}
				}

				// Compile and render bus stops template
				template = Handlebars.compile(source);
				var html    = template(context);
				$("#bus-stops").html(html);

				// If stop was saved
				if (stopValue != null) {
					
					// Select the bus stop previously selected
					$(".bus-stop").val(stopValue).change();
					
					// Trigger event to render stop times
					$("#bus-stops .bus-stop").change();

					// Reset stopValue
					stopValue = null;
				}
			}
		});
}

// After document has loaded
$(document).ready(function() {
	// Declare variables
	

	// When bus route is changed
	$(".bus-route").on("change", function() {
		
		// Hide stop times if showing
		$("#stop-times").html("");

		// Check for no option selected
		if ($(".bus-route option:selected").attr("value") != 0) {
			getSchedule();	
		}
	});

	// When day is changed
	$(".days").on("change", function() {

		// If bus stop already selected
		if ($(".bus-stop option:selected").attr("value") != 0) {
			// Save stop
			stopValue = $(".bus-stop option:selected").attr("value");
		}

		// Check for no bus route selected
		if ($(".bus-route option:selected").attr("value") != 0) {
			getSchedule();	
		}
	});

	// When bus stop is changed
	$("#bus-stops").on("change", ".bus-stop" , function() {
		// Get the name of selected stop
		var stopName = $(".bus-stop option:selected").attr("value");
		
		// Get the timings for the stop
		var stopTimes = currentSchedule[stopName];

		// Build template
		var template;

		// Template source on index view
		var source = $("#stop-times-template").html();

		// Create object to send to template
		var context = {
			stopTime: stopTimes
		}
		template = Handlebars.compile(source);
		var html    = template(context);
		$("#stop-times").html(html);
	});
});
